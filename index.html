<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="">

    <style>
        form, #sim-art {
            margin: 20px;
        }

        #search {
            margin-top: 15px;
        }

        #sim-art {
            display: flex;
        }

        .sa {
            margin: 10px;
        }

        button {
            display: block;
        }

    </style>
</head>

<body>

    <h2>Enter Artist for 5 Similar Artists</h2>

    <form id="artist-form">
        <label for="artist-input">Search:</label>
        <input type="text" id="artist-input"><br>

        <input id="search" type="submit" value="Search">
    </form>

    <div id="sim-art">

    </div>

    <script>

        //Global Variables

        let bandID;
        let newBand0;
        let newBand1;
        let newBand2;
        let newBand3;
        let newBand4;
        let initArtist = document.getElementById("artist-input").value;

        //Arrays

        let similars = [];



        //authorization code from similar stackoverflow issue answered by spotify employee.

        // Get the hash of the url
        const hash = window.location.hash
            .substring(1)
            .split('&')
            .reduce(function (initial, item) {
                if (item) {
                    var parts = item.split('=');
                    initial[parts[0]] = decodeURIComponent(parts[1]);
                }
                return initial;
            }, {});
        window.location.hash = '';

        // Set token
        let _token = hash.access_token;

        const authEndpoint = 'https://accounts.spotify.com/authorize';

        // Replace with your app's client ID, redirect URI and desired scopes
        const clientId = '2ea8916fc375497c977cf897e6533579';
        const redirectUri = 'https://pierrelampre.github.io/spot/';
        const scopes = [
            'playlist-modify-private',
            'playlist-modify-public',
            'user-top-read'
        ];

        // If there is no token, redirect to Spotify authorization
        if (!_token) {
            window.location = `${authEndpoint}?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scopes.join('%20')}&response_type=token`;
        }

        //_end stackoverflow auth fix_

        // necessary functions

        function getSimilarArtists() {

            console.log(initArtist);

            similars = [];


            initArtist = document.getElementById("artist-input").value;
            initArtist = initArtist.split(' ').join('+');

            $.ajax({
                url: "https://api.spotify.com/v1/search?query=" + initArtist + "&offset=0&limit=10&type=artist",
                type: "GET",
                beforeSend: function (xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + _token); },
                success: function (data) {

                    console.log(data);

                    bandID = data.artists.items[0].id.toString();

                    $.ajax({
                        url: "https://api.spotify.com/v1/artists/" + bandID + "/related-artists",
                        type: "GET",
                        beforeSend: function (xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + _token); },
                        success: function (data) {

                            console.log(data);

                            newBand0 = data.artists[0];
                            newBand1 = data.artists[1];
                            newBand2 = data.artists[2];
                            newBand3 = data.artists[3];
                            newBand4 = data.artists[4];

                            similars.push(newBand0);
                            similars.push(newBand1);
                            similars.push(newBand2);
                            similars.push(newBand3);
                            similars.push(newBand4);

                            namesInDiv();
                        }
                    });
                }
            });
        }

        function namesInDiv() {

            $("#sim-art").empty();

            for (let i = 0; i < similars.length; i++) {

                if (i === 4) {
                    $("#sim-art").append("<div class='sa'><img src='" + similars[i].images[0].url + "'width='100' height='100'><button>" + similars[i].name + "</button></span>");
                } else {
                    $("#sim-art").append("<div class='sa'><img src='" + similars[i].images[0].url + "' width='100' height='100'><button>" + similars[i].name + "</button></span>");
                }
                
            }
        }

        function topTracks() {
            
            $.ajax({
                        url: "https://api.spotify.com/v1/artists/" + saID + "/related-artists",
                        type: "GET",
                        beforeSend: function (xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + _token); },
                        success: function (data) {

                            console.log(data);

                        }
                    });
        }

        //functionality for similar artist search

        $("#search").on("click", function (event) {
            event.preventDefault();

            getSimilarArtists();

        })
    </script>
</body>

</html>